# UART_SpiFlash_Programmer_on_FPGA
UART programmer SPI FLASH 25-series on FPGA or CPLD

Представленный проект состоит из двух компонентов: программа для ПК и проект на Verilog, которые превращают практически любую отладочную плату с FPGA в USB программатор SPI флешек. Есть только одно ограничение - на плате должен быть USB-UART конвертер (или можно подключить внешний).
Зачем это нужно? Для удобства. Например: Вы разрабатываете некое устройство на FPGA, у которого данные хранятся на флешке. При отладке приходится часто перезаписывать флешку. Для этого нужно цеплять программатор или доставать флешку из панельки. А так, просто залил прошивку программатора - и готово, можно прошивать не отключая кабеля. По моему очень удобно.
Сама прошивка представляет из себя несколько конечных автомата: UART RX, UART TX, SPI и главный автомат, который синхронизирует их работу. В качестве буфера памяти используется встроенная в FPGA блочная память, сконфигурированная как DUAL PORT RAM на 1Кб. 

Скорость работы программатора достаточно высокая, при скорости UART 921600 бод запись одного мегабайта занимает около 28 секунд. Можно попробовать более высокую скорость UART (2000000, например), если таковую поддерживает USB-UART переходник.

Проект состоит из четырёх файлов: uart_rx.v, uart_tx.v, spi.v и топ модуль uart_prog.v. В первых трёх файлах можно настроить скорость работы каждого модуля и указать входную частоту. В главном модуле uart_prog.v находятся два конечных автомата: первый собирает входящий пакет, записывает его в RAM и даёт команду на обработку пакета; второй автомат более сложный, он обрабатывает принятый пакет, управляет периферическими автоматами (UART_TX, SPI) и организует алгоритмы работы со SPI Flash памятью. В этом автомате используются несколько подпрограм (многократно повторяющихся процедур) и организован простейший стек для сохранения адреса возврата (регистр "ret").

Работа проверена на FPGA Altera Cyclone IV и на Gowin TangNano9k (в последней использовался встроенный USB-UART и прошивалась встроенная SPI Flash, для этого необходимо в настройках проекта указать, что пины Dual purpose MSPI используются в качестве General IO).

Программа для ПК используется из другого моего проекта [UART_Prog](https://github.com/AndrejChoo/uart_prog). Написана на C# для Windows и переписана на Qt для Windows и Linux:

![soft](https://github.com/AndrejChoo/uart_prog/blob/main/software/soft.png)

В данном софте реализована работа только со SPI Flash 25-й серии, элементы на остальных вкладках (24ххб 93Схх) просто игнорируются прошивкой FPGA. В дальнейшем планирую добавить поддержку программирования этих EEPROM, возможно отдельными проектами, чтобы их объём не превышал разумные пределы.

Из нереализованных функций пока только запись SREG1,2, эта функция работает некорректно, всё остальное (запись, чтение, стирание, чтение ID, чтение SREG работает нормально).

